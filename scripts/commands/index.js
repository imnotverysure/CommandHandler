import{system as t,Player as e,world as n}from"@minecraft/server";function defer(e,n,i){t.runTimeout(()=>n(e),i)}function S(t,e){return`${_S(t)}${String(e).replaceAll(_S("r"),`${_S("r")}${_S(t)}`)}${_S("r")}`}function _S(t){return`ยง${t}`}function isString(t){try{return isNaN(t)&&"string"==typeof JSON.parse(t)}catch{return"string"==typeof t}}function isInt(t){return Number.isInteger(Number(t))}function isFloat(t){return!isNaN(t)}function isBoolean(t){try{return"boolean"==typeof JSON.parse(t)}catch{return"boolean"==typeof t}}function isPlayer(t){return t instanceof e||!!n.getPlayers().find(e=>e.name.toLowerCase()===t.toLowerCase()||e.id===t)}function isCoordinate(t,e=!0){return isFloat(t)||e&&isFloat(t.replace(/^~/,"")||0)}const i=console.warn;globalThis.console={...console,warn(...t){i(`${S("6","[Yl-Module]")}`,...t)},log(...t){i(`${S("b","[Yl-Module]")}`,...t)},error(...t){i(`${S("c","[Yl-Module]")}`,...t)}};class Data{depth;name;aliases;permission;description;subcommands;options;constructor(t){this.depth=t.depth??0,this.name=t.name,this.aliases=t.aliases??[],this.permission=t.permission??(t=>t.isValid()),this.description=t.description??"No description",this.subcommands=this.convertSubcommands(t.subcommands??[]),this.options=this.convertOptions(t.options??[])}isKey(t){return this.keys().includes(t)}keys(){return[this.name,...this.aliases]}getRoute(t){return this.getRoutes(this).find(e=>t.every((t,n)=>{const i=e[n];return i&&(i.isKey(t)||"Option"===i.constructor.name&&i.type.verify(t))}))||this.getRoute(t.slice(0,-1))}getRoutes(t=this){const e=this.getAllSubbranches(t);return e.length?e:[[t]]}getSubbranches(t=this){return[...t.subcommands,...t.options]}getAllSubbranches(t=this){return[...t.options,...t.subcommands].map(t=>{const e=this.getAllSubbranches(t);return e.length?e:e.concat([t])}).flat().map(e=>[t].concat(e))}generateRawUsages(){return this.getRoutes().map(t=>[this.name,...this.aliases].map(e=>t.map(t=>{if("Command"===t.constructor.name)return{permission:t.permission,usage:e};const n="optional"in t?t.optional?["[","]"]:["<",">"]:["",""];return{permission:t.permission,usage:`${n[0]}${[t.name,...t.aliases].join("|")}${"type"in t?`: ${t.type.name}`:""}${n[1]}`}}))).flat()}generateUsages(t){const e=this.generateRawUsages().filter(e=>e.every(e=>e.permission(t)));return e.length?e:this.getSubbranches().filter(e=>e.permission(t))?[[{permission:this.permission,usage:this.name}]]:[[{permissions:this.permission,usage:"No usages found"}]]}convertSubcommands(t,e){return(t=>t.map(t=>({...t,depth:this.depth+1})).map(t=>e?new e(t):t))(t)}convertOptions(t,e){return(t=>t.map(t=>({...t,depth:this.depth+1})).map(t=>e?new e(t):t))(t)}}class OptionType{name;_options;constructor(t){this._options=t}getMatches(t){return{isValue:!!t}}get options(){return this._options}verify(t){return!!t}validate(t){return{valid:!!t,message:t?void 0:t}}parse(t){return t}}const InvalidStringType_NonString=()=>"",InvalidStringType_InvalidLength=t=>S("c",`The length of the string must be at least ${S("f",t[0])} characters and ${S("f",t[1])} at most`);const InvalidIntType_NonInt=()=>"",InvalidIntType_OutOfRange=t=>S("c",`The int value must be at least ${S("f",t[0])} and ${S("f",t[1])} at most`);const InvalidFloatType_NonFloat=()=>"",InvalidFloatType_OutOfRange=t=>S("c",`The int value must be at least ${S("f",t[0])} and ${S("f",t[1])} at most`),InvalidFloatType_NoIntAllowed=()=>S("c",`You can't use values that are considered as ${S("f","INT")} in this case`);const InvalidBooleanType_NonBoolean=()=>"";const InvalidPlayerType_NonPlayer=()=>"",InvalidPlayerType_NoPlayerIdAllowed=()=>S("c",`You can't use values that are considered as ${S("f","PLAYER IDS")} in this case`),InvalidPlayerType_NoPlayerNameAllowed=()=>S("c",`You can't use values that are considered as ${S("f","PLAYER NAMES")} in this case`);const InvalidCoordinateType_NonCoordinate=()=>"",InvalidCoordinateType_NoRelativeCoordinateAllowed=()=>S("c",`You can't use values that are considered as ${S("f","RELATIVE COORDINATES")} in this case`);const s={string:class extends OptionType{name="string";_options={length:[0,1/0],...this._options};getMatches(t){return{isString:isString(t),isValidLength:!this._options.length||t.length>=this._options.length[0]&&t.length<=this._options.length[1]}}verify(t){return this.validate(t).valid}validate(t){const e=this.getMatches(t);return e.isValidLength?{valid:e.isString,message:InvalidStringType_NonString()}:{valid:!1,message:InvalidStringType_InvalidLength(this._options.length?.sort((t,e)=>t-e))}}parse(t){return String(t).slice(0,this._options.length?.[1]??1/0)}},int:class extends OptionType{name="int";_options={range:[-1/0,1/0],...this._options};getMatches(t){return{isInt:isInt(t),isWithinRange:t>=Math.min(...this._options.range)&&t<=Math.max(...this._options.range)}}verify(t){return this.validate(t).valid}validate(t){const e=this.getMatches(t);return e.isWithinRange?{valid:e.isInt,message:InvalidIntType_NonInt()}:{valid:!1,message:InvalidIntType_OutOfRange(this._options.range?.sort((t,e)=>t-e))}}parse(t){return parseInt(t)}},float:class extends OptionType{name="float";_options={allowInt:!0,range:[-1/0,1/0],...this._options};getMatches(t){return{isFloat:isFloat(t),isWithinRange:t>=Math.min(...this._options.range)&&t<=Math.max(...this._options.range),isNonFloat:isInt(t)}}verify(t){return this.validate(t).valid}validate(t){const e=this.getMatches(t);return!this._options.allowInt&&e.isNonFloat?{valid:!1,message:InvalidFloatType_NoIntAllowed()}:e.isWithinRange?{valid:e.isFloat,message:InvalidFloatType_NonFloat()}:{valid:!1,message:InvalidFloatType_OutOfRange(this._options.range?.sort((t,e)=>t-e))}}parse(t){return parseFloat(t)}},boolean:class extends OptionType{name="boolean";_options={...this._options};verify(t){return this.validate(t).valid}validate(t){return{valid:isBoolean(t),message:InvalidBooleanType_NonBoolean()}}parse(t){try{return isBoolean(t)&&"string"==typeof t&&!!JSON.parse(t)}catch{return!!t}}},Player:class extends OptionType{name="Player";_options={allowName:!0,...this._options};getMatches(t){return{isPlayer:isPlayer(t),isIdOfPlayer:!!n.getPlayers().find(e=>e.id===t),isNameOfPlayer:!!n.getPlayers({name:t})[0]}}verify(t){return this.validate(t).valid}validate(t){const e=this._options,n=this.getMatches(t);return!e.allowId&&n.isIdOfPlayer?{valid:!1,message:InvalidPlayerType_NoPlayerIdAllowed()}:!e.allowName&&n.isNameOfPlayer?{valid:!1,message:InvalidPlayerType_NoPlayerNameAllowed()}:{valid:n.isPlayer,message:InvalidPlayerType_NonPlayer()}}parse(t){const i=this._options;return t instanceof e?t:i.allowName?n.getPlayers({name:t})[0]:i.allowId?n.getPlayers().find(e=>e.id===t):t}},Coordinate:class extends OptionType{name="Coordinate";_options={allowRelative:!0,...this._options};getMatches(t){return{isCoordinate:isCoordinate(t,this._options.allowRelative),isRelativeCoordinate:isFloat(t.replace(/^~/,"")||0)}}verify(t){return this.validate(t).valid}validate(t){const e=this.getMatches(t);return!this._options.allowRelative&&e.isRelativeCoordinate?{valid:!1,message:InvalidCoordinateType_NoRelativeCoordinateAllowed()}:{valid:e.isCoordinate,message:InvalidCoordinateType_NonCoordinate()}}parse(t,e){return(isString(t)&&/^~/.test(t)?Number(t)+(e??0):NaN)||(isFloat(t)?Number(t):NaN)}}};class Option extends Data{type;optional;constructor(t){super(t),this.type=t.type&&t.type.type?new s[t.type.type](t.type):new s.string({type:"string"}),this.optional=t.optional??!0}convertSubcommands(t){return super.convertSubcommands(t,Subcommand)}convertOptions(t,e){return super.convertOptions(t,Option)}}class Subcommand extends Data{constructor(t){super(t)}convertSubcommands(t){return super.convertSubcommands(t,Subcommand)}convertOptions(t,e){return super.convertOptions(t,Option)}}class Command extends Data{callback;constructor(t){super(t),this.callback=t.callback??(t=>t)}convertSubcommands(t){return super.convertSubcommands(t,Subcommand)}convertOptions(t,e){return super.convertOptions(t,Option)}}var a;function respond(t,e){const n={[a.InvalidCommand]:e=>invalidCommand(t,e.data[0]),[a.InvalidExecutionPermission]:e=>function(t,e){invalidCommand(t,e)}(t,e.data[0]),[a.InvalidArgument]:e=>function(t,e="",n,i=""){const{interactionString:s}=t,a=[...s].map((t,e)=>" "===t?e:void 0).filter(t=>void 0!==t).find((t,e)=>e===n?.depth)??s.length;t.reply(S("c",`Unexpected argument: "${e}" at 1:${a-e.length-1}: "${s.slice(0,a-e.length)}>>${e}<<${s.slice(a)}"${i.length?`. ${i}`:""}`))}(t,...e.data.slice(0,3))};n[e.code]?.(e)}function invalidCommand(t,e){t.reply(S("c",`Unknown command: ${S("f",e??t.arguments[0])}. Please check whether the command exists and that you have permission to use it`))}!function(t){t[t.InvalidCommand=520]="InvalidCommand",t[t.InvalidExecutionPermission=521]="InvalidExecutionPermission",t[t.InvalidArgument=522]="InvalidArgument"}(a||(a={}));class InteractionOptionResolver{_data=[];_interaction;_root;_feedback={code:null,data:[]};constructor(t){this._interaction=t,this._root=this._interaction.manager.retrieve(t.arguments[0]),this.resolve()}resolve(){if(!this._interaction.isCommand())return;if(!this._root)return void(this.feedback.code=a.InvalidCommand);const t=this.modify(this._interaction.arguments);for(const e of this._root.getRoute(t).slice(0,t.length)){const n=t[e.depth];if(!e.permission(this._interaction.sender))return void(this._feedback=this._root===e?{...this.feedback,code:a.InvalidExecutionPermission}:{code:a.InvalidArgument,data:[n]});const i=e instanceof Option?e.type.validate(n):void 0;if(i&&!i.valid)return void(this._feedback={code:a.InvalidArgument,data:[n,e,i.message]})}const e=this.trace();if(e[e.length-1].getSubbranches().filter(t=>(!("optional"in t)||!t.optional)&&t.permission(this._interaction.sender)).length)this._feedback={code:a.InvalidArgument,data:[]};else for(let n=0,i=t[n];n<t.length;n++,i=t[n]){const t=e[n];t&&this._data.push({name:t.name,depth:n,value:i,type:t instanceof Option?t.type:void 0,dataType:t.constructor.name})}}modify(t,e=this._root.getRoute(t)){return t.map((t,n,i)=>{const s=e[e.length-1];return n===e.length-1&&s instanceof Option&&"string"===s.type.name?(t=this._interaction.interactionString.slice(i.map((t,e)=>e<n?t.length:0).reduce((t,e)=>t+e)+n+this._interaction.manager.prefix.length).trim()).replace(/^"|"$/g,""):t}).slice(0,e.length)}trace(t=this.modify(this._interaction.arguments)){const e=[];for(const n of this._root.getRoute(t).slice(0,t.length)){const i=t[n.depth];if(!i||!(n.isKey(i)||n instanceof Option&&n.type.verify(i)))return e;e.push(n)}return e}get feedback(){return this._feedback}getCommand(){return this._root.name}getSubcommand(t){return this._data.find(e=>"Subcommand"===e.dataType&&(e.name===t||e.depth===t))?.name}getOptionData(t,e,n=!0){const i=this._data.find(n=>"Option"===n.dataType&&n.name===t&&n.type.name===e);return{...i,value:n?i&&i.type.parse(i.value):i&&i.value}}getOption(t,e){return this.getOptionData(t,e,!0).value}getString(t){return this.getOption(t,"string")}getInt(t){return this.getOption(t,"int")}getFloat(t){return this.getOption(t,"float")}getBoolean(t){return this.getOption(t,"boolean")}getPlayer(t){return this.getOption(t,"Player")}getCoordinate(t,e){const n=this.getOptionData(t,"Coordinate",!1);return n.type.parse(n.value,this._interaction.sender.location[e])}getCoordinateX(t){return this.getCoordinate(t,"x")}getCoordinateY(t){return this.getCoordinate(t,"y")}getCoordinateZ(t){return this.getCoordinate(t,"z")}}class Interaction{_sender;_interactionString;_manager;_options;constructor(t,e,n){this._sender=t,this._interactionString=n,this._manager=e,this._options=new InteractionOptionResolver(this),this.execute()}get sender(){return this._sender}get interactionString(){return this._interactionString}get manager(){return this._manager}get options(){return this._options}get arguments(){return this._interactionString.slice(this._manager.prefix.length).split(" ").map(t=>t.trim()).filter(t=>t.length)}isCommand(){return!!this.arguments[0].length&&this._interactionString.startsWith(this._manager.prefix)}reply(t,e=!0){try{e?this._sender.sendMessage(t):n.sendMessage(t)}catch{this._sender.sendMessage(S("c","An error occurred"))}}execute(){this.isCommand()&&respond(this,this._manager.execute(this.arguments[0],this))}}class CommandManager{#t=[];prefix="-";constructor(){this.defaultCommands(),this.onChatCommand()}register(t,e){const n=new Command({...t,callback:e}),i=n.keys().find(t=>!!this.retrieve(t));if(i)throw new Error(`[${this.constructor.name}] A command with the key "${i}" already exists`);this.#t.push(n)}execute(t,e){const n=this.retrieve(t);return e.options.feedback.code||n?.callback(e),e.options.feedback}retrieve(t){return this.#t.find(e=>e.isKey(t))}retrieveCommands(){return Object.freeze(this.#t)}defaultCommands(){this.register({name:"help",aliases:["?"],description:"Shows available informations regarding commands",options:[{name:"page",description:"The page of the command list to show",type:{type:"int",range:[1,1/0]}},{name:"command",description:"The command that will have its avaiable information shown"}]},t=>{const e=this.retrieveCommands().filter(e=>e.permission(t.sender)),n=Math.ceil(e.length/8),i=t.options.getInt("page")??1,s=i<1?1:i>n?n:i,a=t.options.getString("command"),o=e.find(t=>t.isKey(a??""));if(!a)return t.reply(S("f",`${S("l",S("b",`Commands [Page ${s} / ${n}]`))}\n${e.slice(e.length*(s-1),e.length*(s-1)+8).map(t=>` ${S("f",`${t.name} ${S("o",`- ${t.description}`)}`)}`).join("\n")}`));if(!o)return invalidCommand(t,a);const r=o.generateUsages(t.sender).map(t=>t.map(t=>t.usage).join(" "));return t.reply(S("f",`${S("l",S("b","Command Information"))}\n ${S("b",`${this.prefix}${o.name} ${o.aliases.length?`[${o.aliases.join(" | ")}]`:""}`)}\n  - ${S("o",o.description)}\n\n${S("b",S("l","Command Usages:"))}\n${r.map(t=>`  ${this.prefix}${t}`).join("\n")}`))})}onChatCommand(){n.beforeEvents.chatSend.subscribe(t=>{new Interaction(t.sender,this,t.message).isCommand()&&(t.cancel=!0)})}}const o=new CommandManager;export{CommandManager,S,_S,o as commands,defer,isBoolean,isCoordinate,isFloat,isInt,isPlayer,isString};
